{% extends "base.html" %} {% block content %}
<div class="hero">
  <h1 class="title">搜索</h1>
  <p class="hero__tagline">在 {{ config.title }} 中查找您需要的内容</p>
  <div class="search__content container">
    <input type="text" id="search-input" placeholder="输入搜索关键词..." />
    <ul id="search-results"></ul>
    <p id="no-results" class="no-results hidden">未找到匹配内容</p>
  </div>
</div>
<script src="https://registry.npmmirror.com/fuse.js/latest/files/dist/fuse.min.js"></script>
<script>
  function debounce(fn, wait) {
    let timeout;
    return function (...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  fetch("/search_index.zh.json")
    .then((response) => {
      if (!response.ok) throw new Error("无法加载搜索索引");
      return response.json();
    })
    .then((data) => {
      const fuse = new Fuse(data, {
        keys: [
          { name: "title", weight: 0.7 },
          { name: "body", weight: 0.3 },
        ],
        threshold: 0.4,
        includeMatches: true,
        minMatchCharLength: 2,
      });
      const input = document.getElementById("search-input");
      const results = document.getElementById("search-results");
      const noResults = document.getElementById("no-results");

      input.addEventListener(
        "input",
        debounce((e) => {
          const query = e.target.value.trim();
          if (query.length < 2) {
            results.innerHTML = "";
            noResults.classList.add("hidden");
            return;
          }
          const searchResults = fuse.search(query);
          results.innerHTML =
            searchResults.length > 0
              ? searchResults
                .map(
                  (result) => `
              <li>
                <a target="_blank" href="${result.item.url}">${result.item.title
                    }</a>
                <small>${result.item.body.slice(0, 100)}${result.item.body.length > 100 ? "..." : ""
                    }</small>
              </li>
            `
                )
                .join("")
              : "";
          noResults.classList.toggle("hidden", searchResults.length > 0);
        }, 300)
      );
    })
    .catch((error) => {
      console.error("搜索初始化失败:", error);
      results.innerHTML = "<li>搜索功能暂不可用，请稍后重试</li>";
    });
</script>
{% endblock content %}